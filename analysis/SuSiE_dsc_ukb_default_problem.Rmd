---
title: "SuSiE problem"
author: "Yuxin Zou"
date: "01/15/2020"
output:
  workflowr::wflow_html:
    code_folding: hide
---

```{r}
library(susieR)
library(glmnet)
```

This data has 3 signals. SuSiE found none of them and 1 false positive CS.

```{r}
dat = readRDS('data/susie_rss_ukb_default_problem/small_data_51.rds')
sim = readRDS('data/susie_rss_ukb_default_problem/small_data_51_sim_gaussian_3.rds')
sumstat = susieR:::univariate_regression(dat$X_sample, sim$Y)
R = cor(dat$X_sample)
```

```{r}
z_scores <- sumstat$betahat / sumstat$sebetahat
susie_plot(z_scores, y = "z", b=sim$meta$true_coef)
```

The underlying causal variables are 266, 373 and 573. The effects are `r sim$meta$true_coef[sim$meta$true_coef!=0]`. The z scores are `r z_scores[sim$meta$true_coef!=0]`.

The correlation between the strongest signal and causal variables are:
```{r}
R[c(304, which(sim$meta$true_coef!=0)), c(304, which(sim$meta$true_coef!=0))]
```

SuSiE model (estimate prior variance, not estimate residual variance):
```{r}
mod = susie(dat$X_sample, sim$Y, estimate_residual_variance = F, estimate_prior_variance=T)
```
The objective is `r mod$elbo[mod$niter]`. The CS is
```{r}
summary(mod)$cs
```

```{r}
susie_plot(mod, y='PIP', b = sim$meta$true_coef)
```

If we initialize at the truth, the model found 2 CSs with true signals.
```{r}
s_init = susie_init_coef(which(sim$meta$true_coef!=0), sim$meta$true_coef[sim$meta$true_coef!=0], nrow(sim$meta$true_coef))
mod_init = susie(dat$X_sample, sim$Y, estimate_residual_variance = F, estimate_prior_variance=T, s_init = s_init)
```
The objective is `r mod_init$elbo[mod_init$niter]`. The CSs are
```{r}
summary(mod_init)$cs
```

```{r}
susie_plot(mod_init, y='PIP', b = sim$meta$true_coef)
```

What about susie_auto?
```{r}
mod_auto = susie_auto(dat$X_sample, sim$Y)
```
The objective is `r mod_auto$elbo[mod_auto$niter]`. The CSs are
```{r}
summary(mod_auto)$cs
```

```{r}
susie_plot(mod_auto, y='PIP', b = sim$meta$true_coef)
```

If we initialize using LASSO, the model found 2 CSs with true signals.
```{r}
fit.lasso = glmnet(dat$X_sample, sim$Y, family="gaussian", alpha=1, dfmax = 10)
lasso.b = fit.lasso$beta[,max(which(fit.lasso$df <= 10))]
s_init = susie_init_coef(which(lasso.b!=0), sumstat$betahat[lasso.b!=0], nrow(sim$meta$true_coef))
mod_init_lasso = susie(dat$X_sample, sim$Y, estimate_residual_variance = F, estimate_prior_variance=T, s_init = s_init, max_iter = 500)
```

The objective is `r mod_init_lasso$elbo[mod_init_lasso$niter]`. The CSs are
```{r}
summary(mod_init_lasso)$cs
```

```{r}
susie_plot(mod_init_lasso, y='PIP', b = sim$meta$true_coef)
```

**RSS model**:
```{r}
mod_rss = susie_rss(z_scores, R, estimate_residual_variance = F, check_z = FALSE)
```
The objective is `r mod_rss$elbo[mod_rss$niter]`. The CS is 
```{r}
summary(mod_rss)$cs
```

```{r}
susie_plot(mod_rss, y='PIP', b = sim$meta$true_coef)
```

If we initialize at truth:
```{r}
s_init = susie_init_coef(which(sim$meta$true_coef!=0), sim$meta$true_coef[sim$meta$true_coef!=0] /sumstat$sebetahat[sim$meta$true_coef!=0], nrow(sim$meta$true_coef))
mod_rss_init = susie_rss(z_scores, R, estimate_residual_variance = F, s_init =  s_init, check_z = F)
```
The objective is `r mod_rss_init$elbo[mod_rss_init$niter]`. The CSs are
```{r}
summary(mod_rss_init)$cs
```

```{r}
susie_plot(mod_rss_init, y='PIP', b = sim$meta$true_coef)
```

If we initialize using LASSO,
```{r}
eigenR = eigen(R, symmetric = T)
eigenR$values[abs(eigenR$values) < 1e-08] = 0
R = eigenR$vectors %*% (t(eigenR$vectors) * eigenR$values)
diag(R) = 1
P = t(eigenR$vectors[,eigenR$values!=0]) * eigenR$values[eigenR$values!=0]^(-0.5)

fit.lasso = glmnet(t(eigenR$vectors[,eigenR$values!=0]) * eigenR$values[eigenR$values!=0]^(0.5) , P%*%z_scores, alpha = 1, dfmax = 10)
lasso.b = fit.lasso$beta[,max(which(fit.lasso$df <= 10))]
s_init = susie_init_coef(which(lasso.b!=0), z_scores[lasso.b!=0], nrow(sim$meta$true_coef))
mod_rss_init_lasso = susie_rss(z_scores, R, estimate_residual_variance = F, s_init = s_init, max_iter = 500, check_z = F)
```

The objective is `r mod_rss_init_lasso$elbo[mod_rss_init_lasso$niter]`. The CSs are
```{r}
summary(mod_rss_init_lasso)$cs
```

```{r}
susie_plot(mod_rss_init_lasso, y='PIP', b = sim$meta$true_coef)
```

## Another failure example

This data has 3 signals. SuSiE found none of them and 2 false positive CSs.

```{r}
dat = readRDS('data/susie_rss_ukb_default_problem/small_data_109.rds')
sim = readRDS('data/susie_rss_ukb_default_problem/small_data_109_sim_gaussian_3.rds')
sumstat = susieR:::univariate_regression(dat$X_sample, sim$Y)
R = cor(dat$X_sample)
```

```{r}
z_scores <- sumstat$betahat / sumstat$sebetahat
susie_plot(z_scores, y = "z", b=sim$meta$true_coef)
```

The underlying causal variables are 266, 373 and 573. The effects are `r sim$meta$true_coef[sim$meta$true_coef!=0]`. The z scores are `r z_scores[sim$meta$true_coef!=0]`.

The correlation between the strongest signal and causal variables are:
```{r}
R[c(234, which(sim$meta$true_coef!=0)), c(234, which(sim$meta$true_coef!=0))]
```

SuSiE model (estimate prior variance, not estimate residual variance):
```{r}
mod = susie(dat$X_sample, sim$Y, estimate_residual_variance = F, estimate_prior_variance=T)
```
The objective is `r mod$elbo[mod$niter]`. The CSs are
```{r}
summary(mod)$cs
```

```{r}
susie_plot(mod, y='PIP', b = sim$meta$true_coef)
```

If we initialize at the truth:
```{r}
s_init = susie_init_coef(which(sim$meta$true_coef!=0), sim$meta$true_coef[sim$meta$true_coef!=0], nrow(sim$meta$true_coef))
mod_init = susie(dat$X_sample, sim$Y, estimate_residual_variance = F, estimate_prior_variance=T, s_init = s_init)
```
The objective is `r mod_init$elbo[mod_init$niter]`. The CSs are
```{r}
summary(mod_init)$cs
```

```{r}
susie_plot(mod_init, y='PIP', b = sim$meta$true_coef)
```

What about susie_auto?
```{r}
mod_auto = susie_auto(dat$X_sample, sim$Y)
```
The objective is `r mod_auto$elbo[mod_auto$niter]`. The CSs are
```{r}
summary(mod_auto)$cs
```

```{r}
susie_plot(mod_auto, y='PIP', b = sim$meta$true_coef)
```

If we initialize using LASSO,
```{r}
fit.lasso = glmnet(dat$X_sample, sim$Y, family="gaussian", alpha=1, dfmax = 10)
lasso.b = fit.lasso$beta[,max(which(fit.lasso$df <= 10))]
s_init = susie_init_coef(which(lasso.b!=0), sumstat$betahat[lasso.b!=0], nrow(sim$meta$true_coef))
mod_init_lasso = susie(dat$X_sample, sim$Y, estimate_residual_variance = F, estimate_prior_variance=T, s_init = s_init, max_iter = 500)
```

The objective is `r mod_init_lasso$elbo[mod_init_lasso$niter]`. The CSs are
```{r}
summary(mod_init_lasso)$cs
```

```{r}
susie_plot(mod_init_lasso, y='PIP', b = sim$meta$true_coef)
```

The objective became lower. It found 3 CSs and non of them contain true signals.

**RSS model**:
```{r}
mod_rss = susie_rss(z_scores, R, estimate_residual_variance = F, check_z = FALSE)
```
The objective is `r mod_rss$elbo[mod_rss$niter]`. The CSs are
```{r}
summary(mod_rss)$cs
```

```{r}
susie_plot(mod_rss, y='PIP', b = sim$meta$true_coef)
```

If we initialize at truth:
```{r}
s_init = susie_init_coef(which(sim$meta$true_coef!=0), sim$meta$true_coef[sim$meta$true_coef!=0] /sumstat$sebetahat[sim$meta$true_coef!=0], nrow(sim$meta$true_coef))
mod_rss_init = susie_rss(z_scores, R, estimate_residual_variance = F, s_init =  s_init, check_z = F)
```
The objective is `r mod_rss_init$elbo[mod_rss_init$niter]`. The CSs are
```{r}
summary(mod_rss_init)$cs
```

```{r}
susie_plot(mod_rss_init, y='PIP', b = sim$meta$true_coef)
```

If we initialize using LASSO,
```{r}
eigenR = eigen(R, symmetric = T)
eigenR$values[abs(eigenR$values) < 1e-08] = 0
R = eigenR$vectors %*% (t(eigenR$vectors) * eigenR$values)
diag(R) = 1
P = t(eigenR$vectors[,eigenR$values!=0]) * eigenR$values[eigenR$values!=0]^(-0.5)

fit.lasso = glmnet(t(eigenR$vectors[,eigenR$values!=0]) * eigenR$values[eigenR$values!=0]^(0.5) , P%*%z_scores, alpha = 1, dfmax = 10)
lasso.b = fit.lasso$beta[,max(which(fit.lasso$df <= 10))]
s_init = susie_init_coef(which(lasso.b!=0), z_scores[lasso.b!=0], nrow(sim$meta$true_coef))
mod_rss_init_lasso = susie_rss(z_scores, R, estimate_residual_variance = F, s_init = s_init, max_iter = 500, check_z = F)
```

The objective is `r mod_rss_init_lasso$elbo[mod_rss_init_lasso$niter]`. The CSs are
```{r}
summary(mod_rss_init_lasso)$cs
```

```{r}
susie_plot(mod_rss_init_lasso, y='PIP', b = sim$meta$true_coef)
```
